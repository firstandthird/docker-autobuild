#!/usr/bin/env node

const confi = require('/app/node_modules/confi');
const runshell = require('/app/node_modules/runshell');
const envs = process.env;

confi({
  configPath: envs.CONFIG_PATH,
  url: envs.CONFIG_URL
}, (err, config) => {
  if (err) {
    throw err;
  }

  let repo = config.repos[envs.GITHUB_REPO];
  if (!repo) {
    console.log(`${envs.GITHUB_REPO} doesn't match config, skipping`);
    return;
  }
  if (config.slack) {
    repo = Object.assign(repo, config.slack);
  }
  if (repo.ONLY_TAGS)  {
    if (envs.GITHUB_BRANCH.indexOf('refs/tags') !== -1) {
      process.env.GITHUB_BRANCH = envs.GITHUB_BRANCH.replace('refs/tags/', '');
    } else {
      console.log(`Set to only tags and got ${envs.GITHUB_BRANCH}`);
      return;
    }
  }
  runshell('/scripts/lib/build', {
    log: true,
    env: repo
  }, (err, out) => {
    if (err) {
      console.log(err);
    }
  });
});
