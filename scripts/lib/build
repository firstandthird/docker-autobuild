#!/bin/bash

#build repo
BUILDER="firstandthird/builder:0.2.3"
docker pull $BUILDER > /dev/null 2>&1
if [[ "$?" != 0 ]]; then
  echo "error pulling image"
  exit 1
fi
docker run \
  --rm \
  -e USER=$GITHUB_USER \
  -e REPO=$GITHUB_REPO \
  -e BRANCH=$GITHUB_BRANCH \
  -e TOKEN=$GITHUB_TOKEN \
  -e DEBUG=1 \
  -e PUSH=1 \
  -e TAG=$TAG \
  -e TAG_PREFIX_BRANCH=$TAG_PREFIX_BRANCH \
  -e TAG_BRANCH=$TAG_BRANCH \
  -e REGISTRY=$REGISTRY \
  -e DOCKER_AUTH=$DOCKER_AUTH \
  -e WEBHOOK=$WEBHOOK \
  -e SLACK_HOOK=$SLACK_HOOK \
  -e SLACK_CHANNEL=$SLACK_CHANNEL \
  -e SLACK_NAME=docker-autobuild \
  -e SLACK_EMOJI=$SLACK_EMOJI \
  -v /var/run/docker.sock:/var/run/docker.sock \
  -v /repos:/repos \
  ${BUILDER}
